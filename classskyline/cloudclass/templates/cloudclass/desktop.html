{% extends "sitebase.html" %}
{% load static from staticfiles %}

{% block ext_style %}
    <!-- BEGIN PAGE LEVEL STYLES -->
    <link rel="stylesheet" type="text/css" href="{% static 'assets/global/plugins/select2/select2.css' %}"/>
    <link rel="stylesheet" type="text/css"
          href="{% static 'assets/global/plugins/datatables/plugins/bootstrap/dataTables.bootstrap.css' %}"/>
    <link href="{% static 'assets/global/css/pagination.css' %}" rel="stylesheet"/>
    <!-- END PAGE LEVEL STYLES -->
{% endblock %}

{% block content %}
    <!-- BEGIN PAGE HEADER-->
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <i class="fa fa-home"></i>
                <a href="/cloudclass/">主页</a>
                <i class="fa fa-angle-right"></i>
            </li>
            <li>
                <a href="#">云桌面</a>
            </li>
        </ul>
        <div class="page-toolbar">

        </div>
    </div>
    <!-- END PAGE HEADER-->


    <div class="clearfix">
    </div>
    <!--虚拟机器列表-->
    <div class="row">
        <div class="col-md-12 col-sm-12">
            <!-- BEGIN EXAMPLE TABLE PORTLET-->
            <div class="portlet box darkgray">

                <div class="portlet-title">
                    <div class="caption">
                        <!--<i class="fa fa-desktop"></i>-->云桌面管理
                    </div>

                    <div class="actions">
                        <a href="#" class="btn btn-default btn-sm btndel">
                            <i class="fa fa-trash"></i> 删除
                        </a>

                        <a href="#" class="btn btn-default btn-sm btnrefresh">
                            <i class="fa fa-refresh"></i> 刷新
                        </a>
                    </div>
                </div>

                <div class="portlet-button">
                    <a href="#" class="btndel" ><i class="fa fa-trash"></i> 删除</a>
                    <a href="#" class="btnrefresh"><i class="fa fa-refresh"></i> 刷新</a>
                    <a href="#" class="btnclosevm" ><i class="fa fa-stop"></i> 关闭桌面</a>
                    <a href="#" class="btnrestartvm" ><i class="fa fa-play"></i> 启动桌面</a>
                </div>

                <div class="portlet-body">
                    <table class="table table-striped table-bordered table-hover" id="sample_2">
                        <thead>
                        <tr>
                            <th class="table-checkbox">
                                <input type="checkbox" class="group-checkable" data-set="#sample_2 .checkboxes"/>
                            </th>
                            <th>序号</th>
                            <th>名称</th>
                            <th>虚拟机IP</th>
                            <th>虚拟机MAC</th>
                            <th>连接状态</th>
                            <th>终端名称</th>
                            <th>终端IP</th>
                            <th>终端MAC</th>
                            <th>运行状态</th>
                        </tr>
                        </thead>

                        <tbody id="desktoplist"></tbody>
                    </table>
                </div>
                <div id="Pagination" class="digg"></div>
            </div>
            <!-- END EXAMPLE TABLE PORTLET-->
        </div>
    </div>
{% endblock content %}

{% block script %}
    <script src="{% static 'assets/global/scripts/jquery.pagination.js' %}"></script>

    <script type="text/javascript">
        var count=0;
        function longPolling() {
            var localstatus = localStorage.getItem("course_status");
            var status = "notonclass";
            $.ajax({
                url: "{% url 'get_courses' %}",
                data: null,
                type: "GET",
                dataType: "json",
                timeout: 10000,
                error: function (XMLHttpRequest, textStatus, errorThrown) {

                    if (textStatus == "timeout") { // 请求超时
                        //longPolling(); // 递归调用
                        // 其他错误，如网络错误等
                    } else {
                       // longPolling();
                    }
                },
                success: function (data, textStatus) {


                    if (textStatus == "success") { // 请求成功
{#                        var courselist = data["courses"];#}
{#                        for (i = 0; i < courselist.length; i++) {#}
{#                            var course = courselist[i];#}
{#                            if (course.state == 1) {#}
{#                                status = "preclass"#}
{##}
{#                                break#}
{#                            }#}
{#                            else if (course.state == 2) {#}
{#                                status = "onclass"#}
{##}
{#                                break#}
{#                            }#}
{#                            else if (course.state == 3) {#}
{#                                status = "endclass"#}
{#                                break#}
{#                            }#}
{##}
{#                        }#}
{#                        localStorage.setItem("course_status", status);#}
{#                        //todo 比较课程状态和本地的缓存状态是否一致#}
{#                        if (localstatus == null) {#}
{#                            localstatus = "notonclass";#}
{#                            localStorage.setItem("course_status", localstatus);#}
{#                        }#}
{#                        if (status != localstatus) {#}
{#                            //todo 获取桌面列表#}
{#                            InitDesktop();#}
{#                        }else{#}
{##}
{#                            //todo 可能为onclass#}
{#                            getdesktopcount();#}
{#                            var currentcount= $("#desktoplist").find("tr").length;#}
{#                            if(count>0&&count!=currentcount){#}
{#                                InitDesktop();#}
{#                            }#}
{#                        }#}
                           getdesktopcount();
                            var currentcount= $("#desktoplist").find("tr").length;
                            if(count!=currentcount){
                                InitDesktop();
                            }

                        //longPolling();
                    }
                },
                complete: function (xhr, textStatus) {
                    xhr = null;
                }
            });
        }

        function getdesktopcount(){
            var opt = {"url": "{% url 'ajax_get_desktops' %}", data: null, "async": false};
        common.ajaxpostrequest(opt, function (rsp) {
            var desktoplist = rsp["desktops"];
             count=desktoplist.length;

        });
        }

         function InitDesktop() {
        var opt = {"url": "{% url 'ajax_get_desktops' %}", data: null, "async": false};
        common.ajaxpostrequest(opt, function (rsp) {
            var desktoplist = rsp["desktops"];

            desktoplist.sort(function(a,b){
                if(a.name < b.name) return -1;
                    if(a.name > b.name) return 1;
                    return 0;
            });
            var str = "";
            for (i = 0; i < desktoplist.length; i++) {
                var j=i+1;
                desktop = desktoplist[i];
                var seq=i+1;
                var connect="";
                if(desktop.tname.length>0){
                    connect="style='color:orange'";
                }
                str += "<tr class=\"odd gradeX\">";


                str += "<td><input type=\"checkbox\" class=\"checkboxes\" value=\"" + desktop.id + "\"/></td>";
                str +="<td>"+seq+"</td>";
                str += "<td>" + desktop.name + "</td>";
                str += "<td>" + desktop.ipaddr + "</td>";
                str += "<td>" + desktop.macaddr + "</td>";

                str += "<td style=\"text-align:center;\"><i class=\"fa fa-sliders\" "+connect+"></i></td>";
                str+="<td>"+desktop.tname+"</td>";
                str += "<td>" + desktop.tip + "</td>";
                str += "<td>" + desktop.tmac + "</td>";
                str += "<td style=\"text-align:center;\"></td>"
                str += "</tr>";

            }
            $("#desktoplist").html(str);
            Metronic.init();
        });
    }
		
		//启动，关闭桌面，刷新桌面，删除桌面
        function sendCommond(commond, sucmsg, errormsg, delmsg) {
            if (commond == "refresh") {
                InitDesktop();
            }
            else {
                var ids = [];
                $("tbody").find(".checker .checked").each(function () {
                    var id = $(this).find("input").val();
                    ids.push(id);
                });
                console.log(ids);
                if (ids.length == 0) {

                    $.MsgBox.Alert("提示", errormsg);
                    return;
                }

                switch (commond) {

                    case "delete":
                        $.MsgBox.Confirm("提示", delmsg, function () {

                            var opt = {
                                url: "{% url 'ajaxdelbatch_desktop' %}",
                                data: {"ids": ids.toString()},
                                async: false
                            };
                            common.ajaxpostrequest(opt, function (rsp) {
                                window.location.reload();

                            });
                        });
                        break;
                    case "poweroff":
                         var opt = {
                            url: "{% url 'ajax_vm_operate' %}",
                            data: {"ids": ids.toString(), "type": commond},
                            async: false
                        };
                        common.ajaxpostrequest(opt, function (rsp) {
                            if (rsp["result"] == "ok") {
                                $.MsgBox.Alert("提示", sucmsg);
                                //关闭成功后连接状态改成灰色
                                $("tbody").find(".checker .checked").each(function () {
                                    var iconTd = $('td:nth-child(6)', $(this).parents('tr'));
                                    var icon = $('i', iconTd);
                                    $(icon).css('color', 'grey');
                                })
                            }
                        });
                        break;
                    case "start":
                        var opt = {
                            url: "{% url 'ajax_vm_operate' %}",
                            data: {"ids": ids.toString(), "type": commond},
                            async: false
                        };

                        common.ajaxpostrequest(opt, function (rsp) {
                            if (rsp["result"] == "ok") {
                                $.MsgBox.Alert("提示", sucmsg);
                                //启动成功后连接状态改成橙色
                                $("tbody").find(".checker .checked").each(function () {
                                    var iconTd = $('td:nth-child(6)', $(this).parents('tr'));
                                    var icon = $('i', iconTd);
                                    $(icon).css('color', 'orange');
                                })
                            }
                        });
                        break;
                }
            }

        }

        //更新虚机运行状态
        function checkRunningStatus() {
            $(".checkboxes").each(function(){
                var vmId = $(this).val();
                if (vmId) {
                    var runningTd = $('td:nth-child(10)', $(this).parents('tr'));
                    var opt = {"url": "{% url 'vnc_operate' %}", "data": {"id": vmId, "operateType": "4"}, "async": true};
                    common.ajaxpostrequest(opt, function (rsp) {
                        var status = rsp["result"];
                        if (status == "running") {
                            var img = "{% static "assets/admin/layout/img/new_images/run.png" %}";
                            runningTd.html("<img src='"+ img +"' alt='已运行' title='已运行' />");
                        }
                        else {
                            var img = "{% static "assets/admin/layout/img/new_images/close.png" %}";
                            runningTd.html("<img src='"+ img +"' alt='已关闭' title='已关闭'/>");
                        }
                    });
                }
            });
        }

        $(document).ready(function () {
            common.initmenu("desktop", "");
            InitDesktop(); //页面加载后马上载入云桌面列表
            setInterval(longPolling,3000);//longPolling();
            checkRunningStatus();//更新虚机运行状态
            setInterval(checkRunningStatus, 10000); 

            //删除桌面操作
            $(".btndel").bind("click", function () {
                sendCommond("delete", "", "至少选择一个桌面", "确认要删除桌面吗？");

            });

            //启动vm
            $(".btnrestartvm").bind("click", function () {

                sendCommond("start", "启动桌面成功", "至少选择一个桌面", "");
            });
            //关闭vm
            $(".btnclosevm").bind("click", function () {
                sendCommond("poweroff", "关闭桌面成功", "至少选择一个桌面", "");

            });
            $(".btnrefresh").bind("click", function () {
                sendCommond("refresh", "", "", "");
                checkRunningStatus();
            });

            //复选框
            $(".group-checkable").click(function () {
                var dom = $(this);
                common.checkallparent("checkboxes", dom);
            })
        })

    </script>

{% endblock script %}
