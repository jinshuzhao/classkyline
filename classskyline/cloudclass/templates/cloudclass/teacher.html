{% extends "sitebase.html" %}
{% load static from staticfiles %}

{% block content %}
    <!--虚拟机器列表-->
    <div class="row">
        <div class="col-md-12 col-sm-12">
            <!-- BEGIN EXAMPLE TABLE PORTLET-->
            <div class="portlet box darkgray">
                <div class="portlet-title">
                    <div class="caption">教师管理</div>
                </div>

                <div class="portlet-button">
                    {% if user.is_superuser %}
                        <a href="#" class="btnadd" data-toggle="modal" data-target="#createTeacherModal"><i class="fa fa-plus"></i>新建</a>
                    {% endif %}
                </div>

                <div class="portlet-body">
                    <table class="table table-striped table-bordered table-hover" id="sample_2">
                        <thead>
                        <tr>
                            <th>用户名</th>
                            <th>姓名</th>
                            <th>创建时间</th>
                            {% if user.is_superuser %}
                            <th>操作</th>
                            {% endif %}
                        </tr>
                        </thead>
                        <tbody id="teacher-list">
                            {% for t in teachers %}
                                <tr>
                                    <td>{{ t.username }}</td>
                                    <td>{{ t.first_name }}</td>
                                    <td>{{ t.date_joined|date:'Y-m-d H:i:s' }}</td>
                                    {% if user.is_superuser %}
                                    <td>
                                        <button data-toggle="modal" data-target="#editTeacherModal" data-teacher_id="{{ t.id }}" type="button" class="btn btn-sm btn-primary edit-teacher">编辑</button>
                                        <button data-teacher_id="{{ t.id }}" type="button" class="btn btn-sm btn-danger del-teacher">删除</button>
                                    </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- END EXAMPLE TABLE PORTLET-->
        </div>
    </div>

    <div class="modal fade" id="createTeacherModal" tabindex="-1" role="dialog" aria-labelledby="createTeacher">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>添加教师</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" id="createTeacherForm">
                        {% csrf_token %}
                        <div class="form-group">
                            <label class="col-sm-3 control-label"><span class="red">*</span>
                                {{ form.username.label }}
                            </label>
                            <div class="col-sm-7">
                                {{ form.username }}
                            </div>
                            <i class="fa fa-info-circle" data-toggle="tooltip" data-placement="right" title="用户名为4~20个字符,仅支持字母、数字、下划线"></i>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label">
                                {{ form.first_name.label }}
                            </label>
                            <div class="col-sm-7">
                                {{ form.first_name }}
                            </div>
                            <i class="fa fa-info-circle" data-toggle="tooltip" data-placement="right" title="建议填写教师真实名字，用于识别账户所属的老师"></i>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label"><span class="red">*</span>
                                {{ form.password.label }}
                            </label>
                            <div class="col-sm-7">
                                {{ form.password }}
                            </div>
                            <i class="fa fa-info-circle" data-toggle="tooltip" data-placement="right" title="密码至少5个字符"></i>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label"><span class="red">*</span>
                                {{ form.password1.label }}
                            </label>
                            <div class="col-sm-7">
                                {{ form.password1 }}
                            </div>
                            <i class="fa fa-info-circle" data-toggle="tooltip" data-placement="right" title="与密码保持一致"></i>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary" id="createTeacherFormSave">保存</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editTeacherModal" tabindex="-1" role="dialog" aria-labelledby="editTeacher">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>重置教师密码</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" id="editTeacherForm">
                        {% csrf_token %}
                        {{ editform.teacher_id }}
                        <div class="form-group">
                            <label class="col-sm-3 control-label"><span class="red">*</span>
                                {{ editform.new_password.label }}
                            </label>
                            <div class="col-sm-7">
                                {{ editform.new_password }}
                            </div>
                            <i class="fa fa-info-circle" data-toggle="tooltip" data-placement="right" title="密码至少5个字符"></i>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label"><span class="red">*</span>
                                {{ editform.re_password.label }}
                            </label>
                            <div class="col-sm-7">
                                {{ editform.re_password }}
                            </div>
                            <i class="fa fa-info-circle" data-toggle="tooltip" data-placement="right" title="两次密码输入必须保持一致"></i>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary" id="editTeacherFormSave">保存</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{%  endblock content %}

{% block script %}
    <script type="text/javascript">
        $("[data-toggle='tooltip']").tooltip();
        common.initmenu("teacher", "teachersub");
        // 新建老师账号
        $("#createTeacherForm").bootstrapValidator({
            feedbackIcons: {
                valid: 'fa fa-check',
                invalid: 'fa fa-remove',
                validating: 'fa fa-refresh'
            },
            fields: {
                username: {
                    validators: {
                        notEmpty: {
                            message: "用户名不能为空"
                        },
                        stringLength: {
                            min: 4,
                            message: "用户名长度至少4个字符"
                        },
                        stringLength: {
                            max: 20,
                            message: "用户名长度不能超过20个字符"
                        },
                        regexp: {
                            regexp: /^[a-z0-9_\s]+$/i,
                            message: '只能使用数字、字母和下划线'
                        }
                    }
                },
                password: {
                    validators: {
                        notEmpty: {
                            message: "密码不能为空"
                        },
                        stringLength: {
                            min: 5,
                            message: "密码长度至少5个字符"
                        }
                    }
                },
                password1: {
                    validators: {
                        notEmpty: {
                            message: "确认密码不能为空"
                        },
                        identical: {
                            field: "password",
                            message: "两次密码输入必须相同"
                        }
                    }
                }
            }
        }).on("success.form.bv", function(e) {
            e.preventDefault();
            loading();
            var $form = $(e.target);
            var opt = {
                "url": "{% url 'ajax_add_teacher' %}",
                "data": $form.serialize(),
                "async": true
            };
            common.ajaxpostrequest(opt, function(res) {
                if (res["result"] == "ok") {
                    notie.alert(1, "添加成功", 2);
                   common.reload_page();
                } else {
                    notie.alert(3, res['message'], 3);
                }
                spinner.stop();
                $(".bg").fadeOut(2000);
            })
        });

        // 点击编辑按钮,设置modal中的教师id
        $(".edit-teacher").on("click", function() {
            var _self = $(this);
            var teacher_id = _self.data("teacher_id");
            $("#id_teacher_id").val(teacher_id);
        });

        // 编辑教师账号(重置密码)
        $("#editTeacherForm").bootstrapValidator({
            feedbackIcons: {
                valid: 'fa fa-check',
                invalid: 'fa fa-remove',
                validating: 'fa fa-refresh'
            },
            fields: {
                new_password: {
                    validators: {
                        notEmpty: {
                            message: "新密码不能为空"
                        },
                        stringLength: {
                            min: 5,
                            message: "密码长度至少5个字符"
                        }
                    }
                },
                re_password: {
                    validators: {
                        notEmpty: {
                            message: "确认密码不能为空"
                        },
                        identical: {
                            field: "new_password",
                            message: "两次密码输入必须相同"
                        }
                    }
                }
            }
        }).on("success.form.bv", function(e) {
            e.preventDefault();
            loading();
            var $form = $(e.target);
            var opt = {
                "url": "{% url 'ajax_edit_teacher' %}",
                "data": $form.serialize(),
                "async": true
            };
            common.ajaxpostrequest(opt, function(res) {
                if (res["result"] == "ok") {
                    notie.alert(1, "修改成功");
                    common.reload_page();
                } else {
                    notie.alert(3, res['message'], 3);
                }
                spinner.stop();
                $(".bg").fadeOut(2000);
            })
        });

        {% if user.is_superuser %}
        // 删除教师账号
        $(".del-teacher").on("click", function() {
            var _self = $(this);
            $.MsgBox.Confirm("提示", "确定删除该账号?",function() {
                loading();
                var teacher_id = _self.data("teacher_id");
                var opt = {
                    "url": "{% url 'ajax_del_teacher' %}",
                    "data": {"teacher_id": teacher_id},
                    "async": true
                };
                common.ajaxpostrequest(opt, function(res) {
                    if (res["result"] == "ok") {
                        notie.alert(1, "删除成功", 2);
                        common.reload_page();
                    } else {
                        notie.alert(3, res['message'], 3);
                    }
                    spinner.stop();
                    $(".bg").fadeOut(2000);
                })
            })
        });
        {% endif %}
    </script>
{% endblock script %}