{% load static from staticfiles %}
<!DOCTYPE HTML>
<html>
<head>
    <title>{{ name }}</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    <link rel="apple-touch-startup-image" href="images/screen_320x460.png"/>
    <link rel="apple-touch-icon" href="images/screen_57x57.png">
    <link rel="stylesheet" href="{% static 'css/base.css' %}" title="plain">
    <link rel="stylesheet" href="{% static 'css/vncstyle.css' %}" title="plain">
    <script src="{% static 'assets/global/plugins/jquery.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/util.js' %}"></script>
</head>
<body>
<div id="noVNC_screen">
    <div id="noVNC_status_bar" class="noVNC_status_bar" style="margin-top: 0px;background: #323232 url('{% static "images/bar-back.png" %}') repeat;">
        <table border=0 width="100%">
            <tr>
                <td>
                    <div id="noVNC_status" style="position: relative; height: 30px;">
                        <ul class="clear">
                            <li class="gray"><span class="Darrow"></span><a href="#"><img class="imageLeft" src="{% static 'images/vm.gif' %}"/>操作</a>
                                <dl>
                                    <dd>
                                        <a href="#" id="startVM" onclick="alertMsg(this, 1, 0)">启动</a>
                                    </dd>
                                    <dd>
                                        <a href="#" id="shutDownVM" onclick="alertMsg(this, 1, 1)">关闭</a>
                                    </dd>
                                    <dd>
                                        <a href="#" id="closeVM" onclick="alertMsg(this, 1, 2)">关闭电源</a>
                                    </dd>
                                </dl>
                            </li>
                            <li class="gray"><span class="Darrow"></span><a href="#">
                                <img class="imageLeft" src="{% static 'images/ctl.png' %}"/>发送按键</a>
                                <dl>
                                    <dd>
                                        <a href="#" id="sendKeys1" onclick="sendCtrlAltDel()">Ctrl+Alt+Del</a>
                                    </dd>
                                    <dd>
                                        <a href="#" id="sendKeys2" onclick="sendAltTab()">Alt+Tab</a>
                                    </dd>
                                    <dd>
                                        <a href="#" id="sendKeys3" onclick="sendCtrlSpace()">Ctrl+Space</a>
                                    </dd>
                                </dl>
                            </li>
                            <li class="first gary">
                                <a id="connect_type" href="#" onclick="operateVM(3)">
                                <img class="imageLeft" src="{% static 'images/disconnect.png' %}"/>断开
                                </a>
                            </li>
                            <li class="first gary">
                                <a href="#" onclick="refreshPage()">
                                    <img class="imageLeft" src="{% static 'images/refresh.gif' %}"/>刷新
                                </a>
                            </li>
                        </ul>
                    </div>
                </td>
                <td width="20%">
                    <div id="vmTitle">正在连接</div>
                </td>
            </tr>
        </table>
    </div>

    <canvas id="noVNC_canvas" width="640px" height="20px" tabindex="0">
        Canvas not supported.
    </canvas>
</div>

<div id="pass_required" class="vnc_password" style="display: none;">
    <table>
        <tr>
            <td><input type="password" id="vnc_password_input" placeholder="请输入密码"/></td>
            <td>
                <button id="vnc_password_btn" onclick="setPassword()">确认</button>
            </td>
        </tr>
    </table>
</div>
<!-- <div id="floatWindow" class="window-overlay"></div> -->
<div id="draggable" class="dragHide">这个可以拖动</div>
<div id="changePasswdDiv" style="display: none;">
    <table>
        <tr>
            <td><label class="uname" for="username">用户名：</label></td>
            <td><input id="username" name="username" type="text" placeholder="请输入用户名"/></td>
        </tr>
        <tr>
            <td><label class="uname" for="passwd">密码：</label></td>
            <td><input id="passwd" name="passwd" type="password" placeholder="请输入密码"/></td>
        </tr>
        <tr>
            <td><label class="uname" for="passwd2">确认密码：</label></td>
            <td><input id="passwd2" name="passwd2" type="password" placeholder="请再次输入密码"/></td>
        </tr>
    </table>
    <button id="passwdbutton1" onclick="changePasswd()">确认</button>
    <button id="passwdbutton2" onclick="closeChangePasswdDiv()">取消</button>
</div>
<div id="confirmDilog" class="dragHide"></div>
<form name="refreshForm" action="{% url 'vnc_view' %}?uuid={{ vmid }}" method="post">
    <input type="hidden" name="domainId" value="Frm/RaGv4AQ="/>
    <input type="hidden" name="title" value="{{ name }}"/>
    <input type="hidden" name="domainName" value="{{ name }}"/>
    <input type="hidden" name="casIp" value="{{ ip }}"/>
    <input type="hidden" name="casPort" value="8080"/>
    <input type="hidden" name="userName" value="admin"/>
    <input type="hidden" name="password" value="L48dyUHQrDQ="/>
    <input type="hidden" name="token" value="{{ name }}{{ vmid }}"/>
    <input type="hidden" name="status" value="running"/>
    <input type="hidden" name="host" value="{{ ip }}"/>
    <input type="hidden" name="port" value="8081"/>
    <input type="hidden" id="hidid" value="{{ vmid }}"/>
</form>
<script>
    // 防止错误关闭页面
    window.onbeforeunload  = function() {
        return "确定已经完成安装？请通过窗口左上角“操作”->“关闭”按钮正常关闭操作系统!"
    };

    // (以下为旧代码)
    var vmname = "{{ name }}";
    var vmid = "{{ vmid }}";
    var ip = "{{ targetip }}";
    function refreshPage() {
        var form = document.forms.refreshForm;
        var vmid = $("#hidid").val();
        var request_url = "{% url 'vnc_operate' %}";
        var dataStr = "id=" + vmid + "&operateType=" + 4;
        $.ajax({
            url: request_url,
            type: "POST",
            data: dataStr,
            success: function (msg) {
                var value = msg["result"]; //msg.trim().split(";");
                location.reload();
                if (value != "running") {
                    updateBarShow();
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alertMsg(1, 0);
            }
        });
    }

    var rDrag = {
        o: null,
        init: function (o) {
            o.onmousedown = this.start;
        },
        start: function (e) {
            var o;
            e = rDrag.fixEvent(e);
            e.preventDefault && e.preventDefault();
            rDrag.o = o = this;
            o.x = e.clientX - rDrag.o.offsetLeft;
            o.y = e.clientY - rDrag.o.offsetTop;
            document.onmousemove = rDrag.move;
            document.onmouseup = rDrag.end;
        },
        move: function (e) {
            e = rDrag.fixEvent(e);
            var oLeft, oTop;
            oLeft = e.clientX - rDrag.o.x;
            oTop = e.clientY - rDrag.o.y;
            rDrag.o.style.left = oLeft + 'px';
            rDrag.o.style.top = oTop + 'px';
        },
        end: function (e) {
            e = rDrag.fixEvent(e);
            rDrag.o = document.onmousemove = document.onmouseup = null;
        },
        fixEvent: function (e) {
            if (!e) {
                e = window.event;
                e.target = e.srcElement;
                e.layerX = e.offsetX;
                e.layerY = e.offsetY;
            }
            return e;
        }
    };

    /*jslint white: false */
    /*global window, $, Util, RFB, */
    "use strict";

    // Load supporting scripts
    Util.load_scripts(["webutil.js", "base64.js", "websock.js", "des.js",
        "keysymdef.js", "keyboard.js", "input.js", "display.js",
        "jsunzip.js", "rfb.js"]);

    var rfb;
    var host, port, password, path, token;
    var status = 'running';
    var connect_status;

    function passwordRequired(rfb) {
        // $D('pass_required').style.display = "block";
    }
    function setPassword() {
        rfb.sendPassword($D('vnc_password_input').value);
        $D('vnc_password_input').value = "";
        $D('pass_required').style.display = "none";
    }
    function sendCtrlAltDel() {
        rfb.sendCtrlAltDel();
        return false;
    }
    function sendAltTab() {
        rfb.sendAltTab();
        return false;
    }
    function sendCtrlSpace() {
        rfb.sendCtrlSpace();
        return false;
    }
    function getWinSize() {
        var xScroll, yScroll, windowWidth, windowHeight, pageWidth, pageHeight;
        // innerHeight获取的是可视窗口的高度，IE不支持此属性
        if (window.innerHeight && window.scrollMaxY) {
            xScroll = document.body.scrollWidth;
            yScroll = window.innerHeight + window.scrollMaxY;
        } else if (document.body.scrollHeight > document.body.offsetHeight) { // all but Explorer Mac
            xScroll = document.body.scrollWidth;
            yScroll = document.body.scrollHeight;
        } else { // Explorer Mac...would also work in Explorer 6 Strict, Mozilla and Safari
            xScroll = document.body.offsetWidth;
            yScroll = document.body.offsetHeight;
        }

        if (self.innerHeight) { // all except Explorer
            windowWidth = self.innerWidth;
            windowHeight = self.innerHeight;
        } else if (document.documentElement
                && document.documentElement.clientHeight) { // Explorer 6 Strict Mode
            windowWidth = document.documentElement.clientWidth;
            windowHeight = document.documentElement.clientHeight;
        } else if (document.body) { // other Explorers
            windowWidth = document.body.clientWidth;
            windowHeight = document.body.clientHeight;
        }

        // for small pages with total height less then height of the viewport
        if (yScroll < windowHeight) {
            pageHeight = windowHeight;
        } else {
            pageHeight = yScroll;
        }

        // for small pages with total width less then width of the viewport
        if (xScroll < windowWidth) {
            pageWidth = windowWidth;
        } else {
            pageWidth = xScroll;
        }

        return {
            'pageWidth': pageWidth,
            'pageHeight': pageHeight,
            'windowWidth': windowWidth,
            'windowHeight': windowHeight
        }
    }
    function alertMsg(cad, mode, type) {
        //mode为空，即只有一个确认按钮，mode为1时有确认和取消两个按钮
        mode = mode || 0;
        var msg;
        if (mode) {
            var barId = cad.id;
            var objectValue = $("#" + barId).css("opacity");
            if (objectValue != "1") {
                return;
            }
            msg = '是否确认' + cad.innerHTML + ' ' + vmname + '' + "?";
        } else {
            msg = cad == 0 ? '操作成功。' : '操作失败。';
        }
        var top = document.body.scrollTop || document.documentElement.scrollTop;
        var isIe = (document.all) ? true : false;
        var isIE6 = isIe && !window.XMLHttpRequest;
        var sTop = document.documentElement.scrollTop || document.body.scrollTop;
        var sLeft = document.documentElement.scrollLeft || document.body.scrollLeft;
        var winSize = getWinSize();
        //alert(winSize.pageWidth);
        //遮罩层
        var styleStr = 'top:0;left:0;position:absolute;z-index:10000;background:#666;width:' + winSize.pageWidth + 'px;height:' + (winSize.pageHeight + 30) + 'px;';
        styleStr += (isIe) ? "filter:alpha(opacity=80);" : "opacity:0.8;"; //遮罩层DIV
        var shadowDiv = document.createElement('div'); //添加阴影DIV
        shadowDiv.style.cssText = styleStr; //添加样式
        shadowDiv.id = "shadowDiv";
        //如果是IE6则创建IFRAME遮罩SELECT
        if (true) {
            var maskIframe = document.createElement('iframe');
            maskIframe.style.cssText = 'width:' + winSize.pageWidth + 'px;height:' + (winSize.pageHeight + 30) + 'px;position:absolute;visibility:inherit;z-index:-1;filter:alpha(opacity=0);';
            maskIframe.frameborder = 0;
            maskIframe.src = "about:blank";
            shadowDiv.appendChild(maskIframe);
        }
        document.body.insertBefore(shadowDiv, document.body.firstChild); //遮罩层加入文档
        //弹出框
        var styleStr1 = 'display:block;position:fixed;_position:absolute;left:' + (winSize.windowWidth / 2 - 200) + 'px;top:' + (winSize.windowHeight / 2 - 150) + 'px;_top:' + (winSize.windowHeight / 2 + top - 150) + 'px;'; //弹出框的位置
        var alertBox = document.createElement('div');
        alertBox.id = 'alertMsg';
        alertBox.style.cssText = styleStr1;
        //创建弹出框里面的内容P标签
        var alertMsg_info = document.createElement('P');
        alertMsg_info.id = 'alertMsg_info';
        alertMsg_info.innerHTML = msg;
        alertBox.appendChild(alertMsg_info);
        //创建按钮
        var btn1 = document.createElement('a');
        btn1.id = 'alertMsg_btn1';
        btn1.href = 'javascript:void(0)';
        btn1.innerHTML = '<cite>确认</cite>';
        btn1.onclick = function () {
            document.body.removeChild(alertBox);
            document.body.removeChild(shadowDiv);
            if (type != null && type != 'undefined') {
                operateVM(type);
            }
        };
        alertBox.appendChild(btn1);
        if (mode === 1) {
            var btn2 = document.createElement('a');
            btn2.id = 'alertMsg_btn2';
            btn2.href = 'javascript:void(0)';
            btn2.innerHTML = '<cite>取消</cite>';
            btn2.onclick = function () {
                document.body.removeChild(alertBox);
                document.body.removeChild(shadowDiv);
                return false;
            };
            alertBox.appendChild(btn2);
        }
        document.body.appendChild(alertBox);
    }

    function operateVM(type) {

        if (type == 3) {
            var typebv = $("#connect_type").css("opacity");
            if (typebv != "1") {
                return;
            }
        }

        var request_url = "{% url 'vnc_operate' %}"; //"http://"+ip+":8080/cas/servlet/noVNCServlet";
        var dataStr = "id=" + vmid + "&operateType=" + type;
        dataStr += "&domainName=" + vmname;
        $.ajax({
            url: request_url,
            type: "POST",
            data: dataStr,
            success: function (msg) {
                if (msg["result"] == "success") {
                    switch (type) {
                        case 0:
                            rfb.connect(host, port, password, path);
                            break;
                        case 2:
                            status = 'shutOff';
                            updateBarShow();
                            break;
                        case 3:
                            if (connect_status == 1) {
                                rfb.connect(host, port, password, path);
                            } else {
                                rfb.disconnect();
                            }
                            break;
                        default:
                            status = 'shutOff';
                            break;
                    }
                } else {
                    alertMsg(1, 0);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alertMsg(1, 0);
            }
        });
    }
    function openChangePasswdDiv() {
        var typebv = $("#changePassbtn").css("opacity");
        if (typebv != "1") {
            return;
        }
        $D('changePasswdDiv').style.display = "block";
        /*防止键盘事件冒泡*/
        $('#changePasswdDiv').bind('keypress keydown keyup', function (event) {
            event.stopPropagation();
        });
    }

    function closeChangePasswdDiv() {
        var username = $('#username');
        var passwd = $('#passwd');
        var passwd2 = $('#passwd2');
        $D('changePasswdDiv').style.display = "none";
        username.val('');
        passwd.val('');
        passwd2.val('');
    }

    function changePasswd() {
        var username = $('#username');
        var passwd = $('#passwd');
        var passwd2 = $('#passwd2');
        if (checkValueIsNull(username) || checkValueIsNull(passwd) || checkValueIsNull(passwd2)) {
            return;
        }
        if (passwd.val() != passwd2.val()) {
            passwd2.focus();
            passwd2.css("border", "1px solid red");
            passwd2.attr("title", "密码和确认密码必须要保持一致！");
            return;
        } else {
            passwd2.attr("title", "");
            passwd2.css("border", "1px solid rgb(178, 178, 178)");
        }

        var request_url = "/cas/servlet/noVNCServlet";
        var dataStr = "id=" + '10765' + "&operateType=" + 4;
        dataStr += "&username=" + username.val() + "&passwd=" + passwd.val();
        $.ajax({
            url: request_url,
            type: "POST",
            data: encodeURI(dataStr),
            success: function (msg) {
                if (msg.trim() == "success") {
                    alertMsg(0, 0);
                } else {
                    alertMsg(1, 0);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alertMsg(1, 0);
            }
        });

        closeChangePasswdDiv();
    }

    function checkValueIsNull(obj) {
        if (!obj.val() || !obj.val().trim()) {
            obj.focus();
            obj.css("border", "1px solid red");
            return true;
        } else {
            obj.css("border", "1px solid rgb(178, 178, 178)");
            return false;
        }
    }

    function xvpShutdown() {
        rfb.xvpShutdown();
        return false;
    }
    function xvpReboot() {
        rfb.xvpReboot();
        return false;
    }
    function xvpReset() {
        rfb.xvpReset();
        return false;
    }
    function updateState(rfb, state, oldstate, msg) {
        var s, sb, ctype, level;
        s = $D('vmTitle');
        sb = $D('noVNC_status_bar');
        ctype = $D('connect_type');
        switch (state) {
            case 'failed':
            case 'fatal':
                level = "error";
                s.innerHTML = '连接失败';
                ctype.innerHTML = '<img class="imageLeft" src="{% static 'images/connect.png' %}"/>连接';
                connect_status = 1;
                break;
            case 'normal':
                level = "normal";
                s.innerHTML = vmname;
                s.title = vmname;
                ctype.innerHTML = '<img class="imageLeft" src="{% static 'images/disconnect.png' %}"/>断开';
                connect_status = 0;
                status = 'running';
                break;
            case 'disconnected':
                level = "disconnected";
                s.innerHTML = '连接断开';
                ctype.innerHTML = '<img class="imageLeft" src="{% static 'images/connect.png' %}"/>连接';
                connect_status = 1;
                break;
            case 'loaded':
                level = "loaded";
                s.innerHTML = '正在连接';
                ctype.innerHTML = '<img class="imageLeft" src="{% static 'images/disconnect.png' %}"/>断开';
                connect_status = 0;
                break;
            default:
                level = "warn";
                ctype.innerHTML = '<img class="imageLeft" src="{% static 'images/connect.png' %}"/>连接';
                connect_status = 1;
                break;
        }

        updateBarShow();
        if (state == "normal") {
            cad.disabled = false;

        } else {
            //    cad.disabled = true;
            xvpInit(0);
        }

        sb.setAttribute("class", "noVNC_status_normal");


    }

    function updateBarShow() {
        var startb = $("#startVM");
        var shutb = $("#shutDownVM");
        var closeb = $("#closeVM");
        var typeb = $("#connect_type");
        var sendKeys1 = $("#sendKeys1");
        var sendKeys2 = $("#sendKeys2");
        var sendKeys3 = $("#sendKeys3");
        startb.css("opacity", status != 'running' ? "1" : "0.5"); //设置透明度
        shutb.css("opacity", status == 'running' ? "1" : "0.5"); //设置透明度
        closeb.css("opacity", status == 'running' ? "1" : "0.5"); //设置透明度
        if (connect_status == 0) {
            typeb.css("opacity", "1"); //设置透明度
        } else if (status == 'running') {
            typeb.css("opacity", "1"); //设置透明度
        } else {
            typeb.css("opacity", "0.5"); //设置透明度
        }
        if (connect_status == 0) {
            sendKeys1.css("opacity", "1");
            sendKeys2.css("opacity", "1");
            sendKeys3.css("opacity", "1");
        } else {
            sendKeys1.css("opacity", "0.5");
            sendKeys2.css("opacity", "0.5");
            sendKeys3.css("opacity", "0.5");
        }
    }

    function xvpInit(ver) {
        var xvpbuttons;
        //xvpbuttons = $D('noVNC_xvp_buttons');
        if (ver >= 1) {
            //xvpbuttons.style.display = 'inline';
        } else {
            //xvpbuttons.style.display = 'none';
        }
    }

    window.onscriptsload = function () {

        WebUtil.init_logging(WebUtil.getQueryVar('logging', 'warn'));
        host = ip;
        port = 8081;
        // if port == 80 (or 443) then it won't be present and should be
        // set manually
        if (!port) {
            if (window.location.protocol.substring(0, 5) == 'https') {
                port = 443;
            }
            else if (window.location.protocol.substring(0, 4) == 'http') {
                port = 80;
            }
        }

        password = WebUtil.getQueryVar('password', '');
        //path = WebUtil.getQueryVar('path', 'websockify');

        var strpath = vmname + vmid;

        console.log(strpath);

        path = "websockify/?token=" + strpath;

        if ((!host) || (!port)) {
            updateState('failed',
                    "Must specify host and port in URL");
            return;
        }

        rfb = new RFB({
            'target': $D('noVNC_canvas'),
            'encrypt': WebUtil.getQueryVar('encrypt',
                    (window.location.protocol === "https:")),
            'repeaterID': WebUtil.getQueryVar('repeaterID', ''),
            'true_color': WebUtil.getQueryVar('true_color', true),
            'local_cursor': WebUtil.getQueryVar('cursor', true),
            'shared': WebUtil.getQueryVar('shared', true),
            'view_only': WebUtil.getQueryVar('view_only', false),
            'updateState': updateState,
            'onXvpInit': xvpInit,
            'onPasswordRequired': passwordRequired
        });
        // if (status.trim() == 'running' || status.trim() == 'paused') {
        rfb.connect(host, port, password, path);
        // }

        var obj = document.getElementById('draggable');
        rDrag.init(obj);

        $('#vmTitle').click(function () {
            $('#vmTitle').focus();
        })
        $('#vmTitle').bind('keypress keydown keyup', function (event) {
            if (event.keyCode == 121) {
                openChangePasswdDiv();
            }
            event.preventDefault();
            event.stopPropagation();
        });

    };
</script>
</body>
</html>


